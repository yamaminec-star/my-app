import json
import os
from pathlib import Path

def extract_file_list(data):
    """JSONã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆã©ã‚“ãªå½¢å¼ã§ã‚‚å¯¾å¿œï¼‰"""
    if isinstance(data, list):
        return set(data)
    elif isinstance(data, dict):
        for key, value in data.items():
            if isinstance(value, list):
                return set(value)
    return set()

def main():
    target_folders_str = os.environ.get('TARGET_FOLDERS', 'textures')
    json_filename = os.environ.get('JSON_FILENAME', 'texture-list.json')
    
    target_dirs = [folder.strip() for folder in target_folders_str.split(',')]
    
    print(f"ğŸ“‹ JSONãƒ•ã‚¡ã‚¤ãƒ«å: {json_filename}")
    print(f"ğŸ“ å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€: {', '.join(target_dirs)}")
    print("=" * 60)
    
    total_deleted = 0
    
    for target_dir in target_dirs:
        dir_path = Path(target_dir)
        
        print(f"\nğŸ“ å‡¦ç†ä¸­: {target_dir}")
        
        if not dir_path.exists():
            print(f"âŒ ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã¾ã›ã‚“")
            continue
        
        json_file = dir_path / json_filename
        
        if not json_file.exists():
            print(f"âŒ {json_filename} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            continue
        
        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
                valid_files = extract_file_list(data)
                
            if not valid_files:
                print(f"âš ï¸ JSONã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ")
                continue
                
            print(f"âœ… ä¿æŒãƒ•ã‚¡ã‚¤ãƒ«: {len(valid_files)}å€‹")
            
        except Exception as e:
            print(f"âŒ JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            continue
        
        files_to_delete = []
        
        for file_path in dir_path.iterdir():
            if file_path.is_file() and file_path.name != json_filename:
                if file_path.name not in valid_files:
                    files_to_delete.append(file_path)
        
        if files_to_delete:
            print(f"ğŸ—‘ï¸ å‰Šé™¤: {len(files_to_delete)}å€‹")
            for f in files_to_delete:
                print(f"   - {f.name}")
                f.unlink()
            total_deleted += len(files_to_delete)
        else:
            print(f"âœ… å‰Šé™¤å¯¾è±¡ãªã—")
    
    print(f"\n{'='*60}")
    print(f"âœ… åˆè¨ˆ {total_deleted} å€‹å‰Šé™¤")
    
    return total_deleted

if __name__ == '__main__':
    main()
